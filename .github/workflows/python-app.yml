# This workflow will install Python dependencies, run tests and lint with a single version of Python
# For more information see: https://docs.github.com/en/actions/automating-builds-and-tests/building-and-testing-python

name: Python application

on:
  push:
    branches: [ "main" ]
    tags:
      - "*.*.*"
  pull_request:
    branches: [ "main" ]

permissions:
  contents: read
  id-token: write

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Fix MQTT TLS key permissions
      run: chmod 644 tests/data/rembus.key

    - name: Set up Python 3.x
      uses: actions/setup-python@v4
      with:
        python-version: "3.x"

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install flake8
        pip install .[test]

    # ----------------------------
    # Start PostgreSQL as a service
    # ----------------------------
    - name: Start PostgreSQL
      uses: Harmon758/postgresql-action@v1
      with:
        postgresql version: 16
        postgresql db: rembus_test
        postgresql username: admin
        postgresql password: secret

    # ----------------------------
    # Start Mosquitto with TLS for MQTT & MQTTS
    # ----------------------------
    - name: Start Mosquitto broker
      run: |
        docker run -d --name mosquitto-ci \
          -p 1883:1883 \
          -p 8883:8883 \
          -v ${{ github.workspace }}/tests/data/mosquitto:/mosquitto/config:ro \
          -v ${{ github.workspace }}/tests/data:/mosquitto/certs:ro \
          eclipse-mosquitto:2.0
        echo "Waiting for Mosquitto to start..."
        sleep 3

    - name: Check Mosquitto health
      run: |
        mosquitto_pub -h localhost -p 1883 -t healthcheck -m ok

    # ----------------------------
    # Lint Python code
    # ----------------------------
    - name: Lint with flake8
      run: |
        flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics
        flake8 . --count --exit-zero --max-complexity=10 --max-line-length=80 --statistics

    # ----------------------------
    # Run pytest (including MQTT/MQTTS tests)
    # ----------------------------
    - name: Test with pytest
      env:
        PYTHONPATH: ${{ github.workspace }}/src
        PGHOST: localhost
        PGPORT: 5432
        PGUSER: admin
        PGPASSWORD: secret
        MQTT_HOST: 127.0.0.1
        MQTT_PORT: 1883
        MQTTS_PORT: 8883
      run: pytest tests --asyncio-mode=auto

    # ----------------------------
    # Upload coverage
    # ----------------------------
    - name: Upload coverage to Codecov
      if: github.event_name == 'push'
      uses: codecov/codecov-action@v5
      with:
        token: ${{ secrets.CODECOV_TOKEN }}

    # ----------------------------
    # Build Python package
    # ----------------------------
    - name: Build distribution
      run: |
        pip install build
        python -m build

    - name: Upload dist as artifact
      uses: actions/upload-artifact@v4
      with:
        name: dist
        path: dist/

  publish-to-pypi:
    name: Publish Python üêç distribution üì¶ to PyPI
    if: startsWith(github.ref, 'refs/tags/')
    needs: build
    runs-on: ubuntu-latest
    environment:
      name: pypi
      url: https://pypi.org/p/rembus
    steps:
      - uses: actions/download-artifact@v4
        with:
          name: dist
          path: dist
      - name: Publish package to PyPI
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          attestations: true
